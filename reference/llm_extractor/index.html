<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Uberti Davide" /><link rel="canonical" href="https://github.com/ubertidavide/fastbots/reference/llm_extractor/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>LLMExtractor - fastbots</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "LLMExtractor";
        var mkdocs_page_input_path = "reference/llm_extractor.md";
        var mkdocs_page_url = "/ubertidavide/fastbots/reference/llm_extractor/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> fastbots
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">fastbots</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../task/">Task</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../page/">Page</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Bot</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../bot/">Bot</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../firefox_bot/">Firefox</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../chrome_bot/">Chrome</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../payload/">Payload</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">LLMExtractor</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../config/">Config</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">fastbots</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">References</li>
      <li class="breadcrumb-item active">LLMExtractor</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="llmextractor">LLMExtractor</h2>


<div class="doc doc-object doc-class">



<a id="fastbots.llm_extractor.LLMExtractor"></a>
  <div class="doc doc-contents first">
          <p class="doc doc-class-bases">
            Bases: <code>object</code></p>

  
      <p>LLM Extractor</p>
<p>This is an extractor utility useful for leveraging the llm ability to extract automatically data from html.
The data must be explained throught a pydantic model, this extractor use the rule to parse and validate correctly
the needed entities.
It uses an OpenAI llm model.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>_bot</code></b>
                  (<code><a class="autorefs autorefs-internal" title="fastbots.bot.Bot" href="../bot/#fastbots.bot.Bot">Bot</a></code>)
              –
              <div class="doc-md-description">
                <p>The bot instance associated with the extractor.</p>
              </div>
            </li>
            <li>
              <b><code>_pydantic_model</code></b>
                  (<code><span title="langchain_core.pydantic_v1.BaseModel">BaseModel</span></code>)
              –
              <div class="doc-md-description">
                <p>The representation of the data needed to extract and validate the parsed data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


  <p><strong>Methods:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
          <tr>
            <td><code>__init__</code></td>
            <td>
              <div class="doc-md-description">
                <p>Bot, pydantic_model: BaseModel): Initialized the LLMExtractor class.</p>
              </div>
            </td>
          </tr>
          <tr>
            <td><code>extract_data</code></td>
            <td>
              <div class="doc-md-description">
                <p>str) -&gt; str: Extract the needed data.</p>
              </div>
            </td>
          </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>fastbots/llm_extractor.py</code></summary>
              <pre class="highlight"><code class="language-python">class LLMExtractor(object):
    """
    LLM Extractor

    This is an extractor utility useful for leveraging the llm ability to extract automatically data from html.
    The data must be explained throught a pydantic model, this extractor use the rule to parse and validate correctly
    the needed entities.
    It uses an OpenAI llm model.

    Attributes:
        _bot (Bot): The bot instance associated with the extractor.
        _pydantic_model (BaseModel): The representation of the data needed to extract and validate the parsed data.

    Methods:
        __init__(self, bot: Bot, pydantic_model: BaseModel): Initialized the LLMExtractor class.
        extract_data(self, locator_name: str) -&gt; str: Extract the needed data.
    """

    def __init__(self, bot: Bot, pydantic_model: BaseModel) -&gt; None:
        """
        Initializes the LLMExtractor class.

        Args:
            bot (Bot): The bot instance associated with the extractor.
            pydantic_model (BaseModel): The representation of the data needed to extract and validate the parsed data.
        """
        super().__init__()

        self._bot: Bot = bot

        llm_model = ChatOpenAI(
            temperature=0, 
            model="gpt-3.5-turbo", 
            openai_api_key=config.OPENAI_API_KEY
        )

        prompt_template = """ given this information {information} of an entity on this piece of html,
            I want you to extract all the information about this entity.
            You are not allowed to make any assumptions while extracting the information.
            Every link you provide should be from the information given.
            There should be no assumptions for Links/URLS.
            You should not return code to do it.:
            You should extract the following text infromation from the html:
            \n{format_instructions} # here we are passing format_instructions
        """

        json_output_parser = JsonOutputParser(
            pydantic_model=pydantic_model
        )

        prompt = PromptTemplate(
            template=prompt_template,
            input_variables=["information"],
            partial_variables={"format_instructions": json_output_parser.get_format_instructions()},
        )

        self._llm_chain = LLMChain(llm=llm_model, prompt=prompt)

    def __locator__(self, locator_name: str) -&gt; tuple:
        """
        Utility method to load a locator.

        The locators in the file must be in the format:
        [llm_extractor]
        locator_name=(By.XPATH, "//html//input")

        Args:
            locator_name (str): The name of the locator.

        Returns:
            tuple: A tuple representing the loaded locator.

        Raises:
            ValueError: If the locator is not enclosed in round brackets or is of an unknown or incorrect format.
        """
        # load the locators from file and interpret that as code
        full_locator: str = self._bot.locator('llm_extractor', locator_name).strip().replace('\\\'',  '\'').replace('\\"', '"')

        if not full_locator.startswith('(') or not full_locator.endswith(')'):
            raise ValueError('The locator must be enclosed in round brackets.')

        # declared locators
        locator_list: List[str] = [
            'By.ID', 'By.XPATH', 'By.NAME', 'By.CLASS_NAME', 'By.CSS_SELECTOR', 
            'By.LINK_TEXT', 'By.PARTIAL_LINK_TEXT', 'By.TAG_NAME'
        ]

        # check the used locator
        parsed_locator: tuple = None
        for locator in locator_list:
            # check that the first characters are them of the locators and the next one of the comma 
            if full_locator[1:-1].strip().startswith(locator) and full_locator[1:-1].strip()[len(locator):].strip().startswith(','):
                # extract the tuple required as locator
                parsed_locator = (
                    eval(locator), 
                    full_locator[1:-1].strip()[len(locator):].strip()[1:].strip()[1:-1]
                )

                logging.debug(f'{locator_name} {parsed_locator}')

                return parsed_locator

        else:
            raise ValueError('The specified locator is unknown or wrong; check by, brackets, and commas.')

    def extract_data(self, locator_name: str) -&gt; str:
        """
        Extract the data as a json string, validated throught the data format specified by the pydantic model.

        The locators in the file must be in the format:
        [llm_extractor]
        locator_name=(By.XPATH, "//html//input")

        Args:
            locator_name (str): The name of the locator.
        """
        try:
            extracted_data = self._llm_chain.invoke(
                input={"information": self._bot.wait.until(EC.presence_of_element_located(self.__locator__(locator_name))).get_attribute('innerHTML')},
                return_only_outputs=True,
            )
            return extracted_data["text"]
        except Exception as e:
            logging.error(e)
            return None</code></pre>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="fastbots.llm_extractor.LLMExtractor.__init__" class="doc doc-heading">
          <code class="highlight language-python">__init__(bot, pydantic_model)</code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Initializes the LLMExtractor class.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>bot</code></b>
                  (<code><a class="autorefs autorefs-internal" title="fastbots.bot.Bot" href="../bot/#fastbots.bot.Bot">Bot</a></code>)
              –
              <div class="doc-md-description">
                <p>The bot instance associated with the extractor.</p>
              </div>
            </li>
            <li>
              <b><code>pydantic_model</code></b>
                  (<code><span title="langchain_core.pydantic_v1.BaseModel">BaseModel</span></code>)
              –
              <div class="doc-md-description">
                <p>The representation of the data needed to extract and validate the parsed data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>fastbots/llm_extractor.py</code></summary>
            <pre class="highlight"><code class="language-python">def __init__(self, bot: Bot, pydantic_model: BaseModel) -&gt; None:
    """
    Initializes the LLMExtractor class.

    Args:
        bot (Bot): The bot instance associated with the extractor.
        pydantic_model (BaseModel): The representation of the data needed to extract and validate the parsed data.
    """
    super().__init__()

    self._bot: Bot = bot

    llm_model = ChatOpenAI(
        temperature=0, 
        model="gpt-3.5-turbo", 
        openai_api_key=config.OPENAI_API_KEY
    )

    prompt_template = """ given this information {information} of an entity on this piece of html,
        I want you to extract all the information about this entity.
        You are not allowed to make any assumptions while extracting the information.
        Every link you provide should be from the information given.
        There should be no assumptions for Links/URLS.
        You should not return code to do it.:
        You should extract the following text infromation from the html:
        \n{format_instructions} # here we are passing format_instructions
    """

    json_output_parser = JsonOutputParser(
        pydantic_model=pydantic_model
    )

    prompt = PromptTemplate(
        template=prompt_template,
        input_variables=["information"],
        partial_variables={"format_instructions": json_output_parser.get_format_instructions()},
    )

    self._llm_chain = LLMChain(llm=llm_model, prompt=prompt)</code></pre>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="fastbots.llm_extractor.LLMExtractor.__locator__" class="doc doc-heading">
          <code class="highlight language-python">__locator__(locator_name)</code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Utility method to load a locator.</p>
<p>The locators in the file must be in the format:
[llm_extractor]
locator_name=(By.XPATH, "//html//input")</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>locator_name</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The name of the locator.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b><code>tuple</code></b>(                <code>tuple</code>
)            –
            <div class="doc-md-description">
              <p>A tuple representing the loaded locator.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>ValueError</code>
              –
              <div class="doc-md-description">
                <p>If the locator is not enclosed in round brackets or is of an unknown or incorrect format.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>fastbots/llm_extractor.py</code></summary>
            <pre class="highlight"><code class="language-python">def __locator__(self, locator_name: str) -&gt; tuple:
    """
    Utility method to load a locator.

    The locators in the file must be in the format:
    [llm_extractor]
    locator_name=(By.XPATH, "//html//input")

    Args:
        locator_name (str): The name of the locator.

    Returns:
        tuple: A tuple representing the loaded locator.

    Raises:
        ValueError: If the locator is not enclosed in round brackets or is of an unknown or incorrect format.
    """
    # load the locators from file and interpret that as code
    full_locator: str = self._bot.locator('llm_extractor', locator_name).strip().replace('\\\'',  '\'').replace('\\"', '"')

    if not full_locator.startswith('(') or not full_locator.endswith(')'):
        raise ValueError('The locator must be enclosed in round brackets.')

    # declared locators
    locator_list: List[str] = [
        'By.ID', 'By.XPATH', 'By.NAME', 'By.CLASS_NAME', 'By.CSS_SELECTOR', 
        'By.LINK_TEXT', 'By.PARTIAL_LINK_TEXT', 'By.TAG_NAME'
    ]

    # check the used locator
    parsed_locator: tuple = None
    for locator in locator_list:
        # check that the first characters are them of the locators and the next one of the comma 
        if full_locator[1:-1].strip().startswith(locator) and full_locator[1:-1].strip()[len(locator):].strip().startswith(','):
            # extract the tuple required as locator
            parsed_locator = (
                eval(locator), 
                full_locator[1:-1].strip()[len(locator):].strip()[1:].strip()[1:-1]
            )

            logging.debug(f'{locator_name} {parsed_locator}')

            return parsed_locator

    else:
        raise ValueError('The specified locator is unknown or wrong; check by, brackets, and commas.')</code></pre>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="fastbots.llm_extractor.LLMExtractor.extract_data" class="doc doc-heading">
          <code class="highlight language-python">extract_data(locator_name)</code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Extract the data as a json string, validated throught the data format specified by the pydantic model.</p>
<p>The locators in the file must be in the format:
[llm_extractor]
locator_name=(By.XPATH, "//html//input")</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>locator_name</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The name of the locator.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>fastbots/llm_extractor.py</code></summary>
            <pre class="highlight"><code class="language-python">def extract_data(self, locator_name: str) -&gt; str:
    """
    Extract the data as a json string, validated throught the data format specified by the pydantic model.

    The locators in the file must be in the format:
    [llm_extractor]
    locator_name=(By.XPATH, "//html//input")

    Args:
        locator_name (str): The name of the locator.
    """
    try:
        extracted_data = self._llm_chain.invoke(
            input={"information": self._bot.wait.until(EC.presence_of_element_located(self.__locator__(locator_name))).get_attribute('innerHTML')},
            return_only_outputs=True,
        )
        return extracted_data["text"]
    except Exception as e:
        logging.error(e)
        return None</code></pre>
          </details>
  </div>

</div>



  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../payload/" class="btn btn-neutral float-left" title="Payload"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../config/" class="btn btn-neutral float-right" title="Config">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../payload/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../config/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
